<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu lugar - BoardXperience Surf Camp</title>
    <!-- Modern Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #10b981;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f3f4f6;
            --shadow-premium: 0 20px 40px rgba(15, 23, 42, 0.15);
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        /* Reset b√°sico */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* HERO con Video de Surfing */
        .hero {
            position: relative;
            height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: left;
            color: #ffffff;
            overflow: hidden;
        }

        .hero-video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            object-fit: cover;
            z-index: -2;
            filter: brightness(0.65);
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom,
                    rgba(0, 0, 0, 0.4) 0%,
                    rgba(0, 0, 0, 0.1) 60%,
                    rgba(243, 244, 246, 1) 100%);
            z-index: -1;
        }

        .hero-content {
            position: relative;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
            z-index: 1;
        }

        .hero-eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.4em;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            color: #f9d27d;
            font-weight: 700;
        }

        .hero-title {
            font-size: clamp(2.8rem, 7vw, 4.5rem);
            line-height: 1;
            margin-bottom: 1.25rem;
            font-weight: 800;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .hero-subtitle {
            max-width: 42rem;
            font-size: 1.35rem;
            opacity: 0.95;
            font-weight: 400;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        /* Layout principal */
        .container {
            max-width: 1100px;
            margin: -120px auto 50px;
            padding: 0 24px 60px;
            position: relative;
            z-index: 10;
        }

        /* Card principal */
        .booking-card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-premium);
            padding: 60px;
            transition: opacity 0.4s ease;
        }

        /* T√≠tulos pasos */
        .step-title {
            font-size: 1.4rem;
            color: var(--text-dark);
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            font-weight: 800;
            letter-spacing: -0.02em;
            gap: 12px;
        }

        .step-title span {
            color: var(--primary);
            font-size: 1.1rem;
            opacity: 0.8;
        }

        /* House Gallery Section */
        .house-preview-container {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 30px;
            margin-bottom: 50px;
        }

        @media (max-width: 768px) {
            .house-preview-container {
                grid-template-columns: 1fr;
            }
        }

        .gallery-container {
            position: relative;
            width: 100%;
            height: 350px;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: #e2e8f0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .gallery-track {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gallery-item {
            min-width: 100%;
            height: 100%;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-nav {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        .gallery-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gallery-dot.active {
            background: white;
            transform: scale(1.3);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .gallery-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .gallery-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .gallery-btn.prev {
            left: 15px;
        }

        .gallery-btn.next {
            right: 15px;
        }

        /* Form Controls */
        label {
            display: block;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 12px;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #f1f5f9;
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            background: #f8fafc;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: #ffffff;
            box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.08);
        }

        /* Room Type Grid */
        .room-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .room-option {
            background: #ffffff;
            border: 2px solid #f1f5f9;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .room-option:hover:not(.disabled) {
            border-color: var(--primary);
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }

        .room-option.active {
            border-color: var(--primary);
            background: #ffffff;
            box-shadow: 0 15px 30px -5px rgba(102, 126, 234, 0.2);
        }

        .room-image-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
        }

        .room-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .room-option:hover .room-image-container img {
            transform: scale(1.1);
        }

        .room-info {
            padding: 24px;
        }

        .room-option.full-house-option {
            grid-column: 1 / -1;
            flex-direction: row;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        @media (max-width: 768px) {
            .room-option.full-house-option {
                flex-direction: column;
            }
        }

        .room-option.full-house-option .room-image-container {
            width: 40%;
            height: auto;
            min-height: 220px;
        }

        @media (max-width: 768px) {
            .room-option.full-house-option .room-image-container {
                width: 100%;
                height: 200px;
            }
        }

        .room-option.full-house-option .room-info {
            width: 60%;
            padding: 32px;
        }

        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: #ffffff;
            border: none;
            padding: 20px 40px;
            border-radius: 999px;
            font-size: 1.05rem;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            transition: all 0.4s;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 30px -5px rgba(102, 126, 234, 0.4);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            filter: brightness(1.1);
        }

        .btn:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Success Message */
        #successMessage {
            display: none;
            text-align: center;
            padding: 80px 0;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .availability-badge {
            align-self: flex-start;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 12px;
            display: inline-block;
        }

        .available {
            background: #dcfce7;
            color: #15803d;
        }

        .unavailable {
            background: #fee2e2;
            color: #b91c1c;
        }

        .loader {
            border: 3.5px solid rgba(255, 255, 255, 0.3);
            border-top: 3.5px solid white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>

<body>
    <!-- HERO con Video cinematico -->
    <header id="mainHero" class="hero">
        <video id="heroVideo" class="hero-video" autoplay loop muted playsinline
            poster="https://p0.pxfuel.com/preview/44/149/1015/surf-surfer-surfing-ocean.jpg">
            <source
                src="https://assets.mixkit.co/videos/preview/mixkit-surfer-catching-a-wave-in-the-ocean-4431-large.mp4"
                type="video/mp4">
        </video>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <p class="hero-eyebrow">The Ultimate Surf Experience üåä</p>
            <h1 id="heroTitle" class="hero-title">BoardXperience Camp</h1>
            <p id="heroSubtitle" class="hero-subtitle">
                Donde las olas perfectas y la buena energ√≠a se encuentran. Tu mejor trip est√° por comenzar.
            </p>
        </div>
    </header>

    <main class="container">
        <!-- FORMULARIO PRINCIPAL -->
        <section class="booking-card" id="bookingForm">

            <!-- PASO 1 -->
            <h2 class="step-title"><span>01.</span> Tu Destino</h2>

            <div class="house-preview-container">
                <div class="gallery-container" id="houseGallery">
                    <button class="gallery-btn prev" onclick="moveGallery(-1)">‚ùÆ</button>
                    <button class="gallery-btn next" onclick="moveGallery(1)">‚ùØ</button>
                    <div class="gallery-track" id="galleryTrack">
                        <!-- Se carga con JS -->
                    </div>
                    <div class="gallery-nav" id="galleryNav">
                        <!-- Se carga con JS -->
                    </div>
                </div>

                <div class="house-selection-controls">
                    <div class="form-group">
                        <label for="houseSelect">Selecciona tu Casa</label>
                        <select id="houseSelect" onchange="handleHouseChange()">
                            <!-- opciones se cargan con JS -->
                        </select>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr;">
                        <div class="form-group">
                            <label for="checkIn">Llegada</label>
                            <input type="date" id="checkIn" onchange="checkAvailability()" />
                        </div>
                        <div class="form-group">
                            <label for="checkOut">Salida</label>
                            <input type="date" id="checkOut" onchange="checkAvailability()" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- PASO 2 -->
            <h2 class="step-title" style="margin-top: 40px;"><span>02.</span> Tu Habitaci√≥n</h2>
            <div id="roomsGrid" class="room-type-grid">
                <p
                    style="grid-column: 1 / -1; color: var(--text-light); text-align: center; padding: 60px 0; font-size: 1.1rem; border: 2px dashed #f1f5f9; border-radius: 20px;">
                    ‚ú® Selecciona tus fechas para descubrir las opciones disponibles...
                </p>
            </div>

            <!-- PASO 3 -->
            <section id="personalData"
                style="opacity: 0.2; pointer-events: none; transition: all 0.6s; border-top: 2px solid #f1f5f9; padding-top: 60px; margin-top: 20px;">
                <h2 class="step-title"><span>03.</span> Detalles Personales</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="guestName">Nombre de la Reserva</label>
                        <input type="text" id="guestName" placeholder="Tu nombre completo" />
                    </div>
                    <div class="form-group">
                        <label for="guestEmail">Correo Electr√≥nico</label>
                        <input type="email" id="guestEmail" placeholder="email@ejemplo.com" />
                    </div>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label for="guestPhone">WhatsApp / Tel√©fono</label>
                        <input type="tel" id="guestPhone" placeholder="+54 9 11 ..." />
                    </div>
                    <div class="form-group">
                        <label for="surfLevel">¬øCu√°l es tu nivel de Surf?</label>
                        <select id="surfLevel">
                            <option value="principiante">üèÑ‚Äç‚ôÇÔ∏è Principiante (Quiero aprender)</option>
                            <option value="intermedio">üåä Intermedio (Ya me paro)</option>
                            <option value="avanzado">üî• Avanzado (Le doy a todo)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Mensaje o preferencias especiales</label>
                    <textarea id="notes" rows="4"
                        placeholder="Contanos algo m√°s sobre tu viaje o si ten√©s alguna alergia/preferencia..."></textarea>
                </div>

                <div style="margin-top: 60px;">
                    <button id="submitBtn" class="btn" onclick="submitReservation()" disabled>
                        Confirmar Solicitud de Reserva
                    </button>
                </div>
            </section>
        </section>

        <!-- MENSAJE √âXITO -->
        <section id="successMessage" class="booking-card">
            <span style="font-size: 5rem; display: block; margin-bottom: 24px;">ü§ô</span>
            <h2>¬°Tu lugar est√° casi listo!</h2>
            <p>
                Recibimos tu solicitud para las fechas: <br>
                <strong id="summaryDates"
                    style="color: var(--text-dark); background: #fef3c7; padding: 4px 12px; border-radius: 8px;"></strong>
            </p>
            <p>Nos pondremos en contacto contigo v√≠a WhatsApp para confirmar los detalles finales.</p>
            <button class="btn" onclick="location.reload()" style="max-width: 320px; margin: 40px auto 0;">
                Hacer otra reserva
            </button>
        </section>
    </main>

    <script>
        let reservations = [];
        let selectedBedId = null;
        let isFullHouseSelection = false;
        let selectedHouseId = null;
        let houses = [];
        let currentGalleryIndex = 0;
        let galleryImages = [];

        async function init() {
            try {
                const { data: houseData, error: hErr } = await supabaseClient
                    .from('houses')
                    .select('*, rooms(*, beds(*))');

                if (hErr) throw hErr;
                houses = houseData;

                const select = document.getElementById('houseSelect');
                houses.forEach((h, i) => {
                    const opt = document.createElement('option');
                    opt.value = h.id;
                    opt.textContent = `${h.icon || 'üè†'} ${h.name}`;
                    if (i === 0) opt.selected = true;
                    select.appendChild(opt);
                });

                if (houses.length > 0) handleHouseChange();

                const { data: resData } = await supabaseClient.from('reservations').select('*');
                if (resData) reservations = resData;

                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkIn').min = today;
                document.getElementById('checkOut').min = today;

            } catch (e) {
                console.error(e);
                alert("Error cargando el sistema.");
            }
        }

        function handleHouseChange() {
            const houseId = document.getElementById('houseSelect').value;
            selectedHouseId = houseId;
            const house = houses.find(h => h.id == houseId);

            // Simular multiples fotos por casa (en el futuro vendr√° de DB)
            galleryImages = [
                house.image_url || 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=1200&q=80',
                'https://images.unsplash.com/photo-1590490360182-c33d57733427?auto=format&fit=crop&w=1200&q=80',
                'https://images.unsplash.com/photo-1542718610-a1d656d1884c?auto=format&fit=crop&w=1200&q=80',
                'https://images.unsplash.com/photo-1566665797739-1674de7a421a?auto=format&fit=crop&w=1200&q=80',
                'https://images.unsplash.com/photo-1555854877-bab0e564b8d5?auto=format&fit=crop&w=1200&q=80'
            ];

            updateGallery();
            document.getElementById('heroTitle').textContent = house.name;
            checkAvailability();
        }

        function updateGallery() {
            const track = document.getElementById('galleryTrack');
            const nav = document.getElementById('galleryNav');
            currentGalleryIndex = 0;

            track.innerHTML = galleryImages.map(img => `
                <div class="gallery-item">
                    <img src="${img}" alt="House detail">
                </div>
            `).join('');

            nav.innerHTML = galleryImages.map((_, i) => `
                <button class="gallery-dot ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></button>
            `).join('');

            track.style.transform = `translateX(0)`;
        }

        function moveGallery(step) {
            currentGalleryIndex = (currentGalleryIndex + step + galleryImages.length) % galleryImages.length;
            goToSlide(currentGalleryIndex);
        }

        function goToSlide(index) {
            currentGalleryIndex = index;
            const track = document.getElementById('galleryTrack');
            track.style.transform = `translateX(-${index * 100}%)`;

            const dots = document.querySelectorAll('.gallery-dot');
            dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
        }

        async function checkAvailability() {
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;
            if (!checkIn || !checkOut || !selectedHouseId) return;

            const grid = document.getElementById('roomsGrid');
            const house = houses.find(h => h.id == selectedHouseId);

            const { data: freshRes } = await supabaseClient.from('reservations').select('*');
            if (freshRes) reservations = freshRes;

            grid.innerHTML = '';

            // CASA COMPLETA
            let houseBeds = [];
            house.rooms.forEach(r => houseBeds.push(...r.beds));
            const isFullHouseAvailable = !houseBeds.some(bed =>
                reservations.some(res => res.bed_id === bed.id && res.status !== 'cancelado' && res.check_in < checkOut && res.check_out > checkIn)
            );

            if (isFullHouseAvailable) {
                const fhCard = document.createElement('div');
                fhCard.className = 'room-option full-house-option';
                fhCard.innerHTML = `
                    <div class="room-image-container">
                        <img src="${galleryImages[2]}" alt="Full camp">
                    </div>
                    <div class="room-info">
                        <div class="availability-badge">‚ú® ¬°Exclusivo!</div>
                        <h3>EXPERIENCIA CASA COMPLETA</h3>
                        <p>Reserva todo el resort para tu grupo. Privacidad absoluta y staff dedicado.</p>
                    </div>
                `;
                fhCard.onclick = () => selectFullHouse(fhCard);
                grid.appendChild(fhCard);
            }

            house.rooms.forEach(room => {
                const availableBeds = room.beds.filter(bed => !reservations.some(res => res.bed_id === bed.id && res.status !== 'cancelado' && res.check_in < checkOut && res.check_out > checkIn));
                const isFull = availableBeds.length === 0;
                const roomImg = room.image_url || (room.type === 'PRIVADA' ? galleryImages[3] : galleryImages[4]);

                const card = document.createElement('div');
                card.className = `room-option ${isFull ? 'disabled' : ''}`;
                card.innerHTML = `
                    <div class="room-image-container">
                        <img src="${roomImg}" alt="${room.name}">
                    </div>
                    <div class="room-info">
                        <div class="availability-badge ${isFull ? 'unavailable' : 'available'}">${isFull ? 'Ocupado' : availableBeds.length + ' libres'}</div>
                        <h3>${room.name}</h3>
                        <p>${room.type === 'PRIVADA' ? 'üõå Habitaci√≥n Privada' : 'üë• Habitaci√≥n Compartida'}</p>
                    </div>
                `;
                if (!isFull) card.onclick = () => selectRoom(card, availableBeds[0].id);
                grid.appendChild(card);
            });
        }

        function selectRoom(el, id) {
            document.querySelectorAll('.room-option').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            selectedBedId = id; isFullHouseSelection = false; enablePersonalData();
        }

        function selectFullHouse(el) {
            document.querySelectorAll('.room-option').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            isFullHouseSelection = true; selectedBedId = null; enablePersonalData();
        }

        function enablePersonalData() {
            const p = document.getElementById('personalData');
            p.style.opacity = "1"; p.style.pointerEvents = "all";
            document.getElementById('submitBtn').disabled = false;
        }

        async function submitReservation() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loader"></span> Procesando...';

            try {
                const groupId = isFullHouseSelection ? crypto.randomUUID() : null;
                const house = houses.find(h => h.id == selectedHouseId);
                let beds = isFullHouseSelection ? house.rooms.flatMap(r => r.beds) : [{ id: selectedBedId }];

                for (const bed of beds) {
                    await supabaseClient.from('reservations').insert({
                        id: crypto.randomUUID(),
                        bed_id: bed.id,
                        guest_name: isFullHouseSelection ? `${document.getElementById('guestName').value} (GRUPO)` : document.getElementById('guestName').value,
                        guest_email: document.getElementById('guestEmail').value,
                        guest_phone: document.getElementById('guestPhone').value,
                        check_in: document.getElementById('checkIn').value,
                        check_out: document.getElementById('checkOut').value,
                        status: 'pendiente',
                        surf_level: document.getElementById('surfLevel').value,
                        notes: document.getElementById('notes').value,
                        full_house_group_id: groupId
                    });
                }
                document.getElementById('bookingForm').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('summaryDates').textContent = `${document.getElementById('checkIn').value} al ${document.getElementById('checkOut').value}`;
            } catch (e) {
                btn.disabled = false; btn.innerHTML = 'Confirmar';
            }
        }
        init();
    </script>
</body>

</html>