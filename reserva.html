<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu lugar - BoardXperience Surf Camp</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #10b981;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f3f4f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1502680390469-be75c86b636f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            height: 40vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            padding: 20px;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1000px;
            margin: -50px auto 50px;
            padding: 0 20px;
        }

        .booking-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }

        .step-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .room-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .room-option {
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .room-option:hover {
            border-color: var(--primary);
            background: #f9fafb;
        }

        .room-option.active {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .room-option h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .room-option p {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .room-option .price {
            margin-top: 10px;
            font-weight: 700;
            color: var(--primary);
        }

        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .availability-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 10px;
        }

        .available {
            background: #dcfce7;
            color: #166534;
        }

        .unavailable {
            background: #fee2e2;
            color: #991b1b;
        }

        #successMessage {
            display: none;
            text-align: center;
            padding: 60px 40px;
        }

        #successMessage h2 {
            font-size: 2rem;
            color: var(--accent);
            margin-bottom: 15px;
        }

        #successMessage p {
            color: var(--text-light);
            margin-bottom: 30px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 600px) {
            .room-type-grid {
                grid-template-columns: 1fr;
            }

            .hero h1 {
                font-size: 2rem;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>

<body>

    <section class="hero">
        <div>
            <h1>Vive la Xperience üåä</h1>
            <p>Reserva tu lugar en BoardXperience Surf Camp</p>
        </div>
    </section>

    <div class="container">
        <div class="booking-card" id="bookingCard">
            <div id="bookingForm">
                <div class="step-title"><span>1.</span> Elige tus fechas y casa</div>
                <div class="grid">
                    <div class="form-group">
                        <label>Fecha de Entrada</label>
                        <input type="date" id="checkIn" onchange="checkAvailability()">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Salida</label>
                        <input type="date" id="checkOut" onchange="checkAvailability()">
                    </div>
                    <div class="form-group">
                        <label>Elegir Casa</label>
                        <select id="houseSelect" onchange="checkAvailability()">
                            <!-- Se cargar√° desde Supabase -->
                        </select>
                    </div>
                </div>

                <div class="step-title"><span>2.</span> Selecciona tu habitaci√≥n</div>
                <div id="roomsGrid" class="room-type-grid">
                    <p style="grid-column: 1/-1; text-align: center; color: var(--text-light);">Selecciona fechas para
                        ver disponibilidad...</p>
                </div>

                <div id="personalData" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
                    <div class="step-title"><span>3.</span> Tus datos</div>
                    <div class="grid">
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" id="guestName" placeholder="Juan P√©rez">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="guestEmail" placeholder="juan@ejemplo.com">
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>Nivel de Surf</label>
                            <select id="surfLevel">
                                <option value="principiante">Principiante</option>
                                <option value="intermedio">Intermedio</option>
                                <option value="avanzado">Avanzado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono (WhatsApp)</label>
                            <input type="tel" id="guestPhone" placeholder="+54 9 11 ...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Mensaje / Notas adicionales</label>
                        <textarea id="notes" rows="3"
                            placeholder="Contanos algo m√°s sobre tu viaje o preferencias..."></textarea>
                    </div>

                    <button class="btn" id="submitBtn" onclick="submitReservation()" disabled>
                        Enviar solicitud de reserva
                    </button>
                    <p style="text-align: center; font-size: 0.8rem; color: var(--text-light); margin-top: 15px;">
                        * El equipo de admin revisar√° tu solicitud y se pondr√° en contacto contigo.
                    </p>
                </div>
            </div>

            <div id="successMessage">
                <h2>¬°Solicitud Enviada! ü§ô</h2>
                <p>Recibimos tu solicitud para las fechas <span id="summaryDates"></span>. <br> Revisaremos la
                    disponibilidad y te contactaremos por WhatsApp o Email para confirmar el pago.</p>
                <button class="btn" onclick="location.reload()" style="max-width: 250px;">Volver a empezar</button>
            </div>
        </div>
    </div>

    <script>
        let houses = [];
        let reservations = [];
        let selectedBedId = null;

        async function init() {
            try {
                // Cargar Casas y sus habitaciones/camas
                const { data: houseData, error: hErr } = await supabaseClient
                    .from('houses')
                    .select('*, rooms(*, beds(*))');

                if (hErr) throw hErr;
                houses = houseData;

                const select = document.getElementById('houseSelect');
                houses.forEach((h, i) => {
                    const opt = document.createElement('option');
                    opt.value = h.id;
                    opt.textContent = `${h.icon} ${h.name}`;
                    if (i === 0) opt.selected = true;
                    select.appendChild(opt);
                });

                // Cargar todas las reservas actuales para checkear solapamientos
                const { data: resData, error: rErr } = await supabaseClient
                    .from('reservations')
                    .select('*');

                if (rErr) throw rErr;
                reservations = resData;

                // Set check-in min as today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkIn').min = today;
                document.getElementById('checkOut').min = today;

            } catch (e) {
                console.error(e);
                alert("Error cargando el sistema. Por favor intenta m√°s tarde.");
            }
        }

        async function checkAvailability() {
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;
            const houseId = document.getElementById('houseSelect').value;
            const grid = document.getElementById('roomsGrid');

            if (!checkIn || !checkOut || !houseId) return;

            if (checkIn >= checkOut) {
                grid.innerHTML = '<p style="color: #f44336; text-align: center; width: 100%;">La fecha de salida debe ser posterior a la de entrada.</p>';
                return;
            }

            // Refrescar reservas locales antes de chequear
            const { data: freshRes } = await supabaseClient.from('reservations').select('*');
            if (freshRes) reservations = freshRes;

            const house = houses.find(h => h.id == houseId);
            grid.innerHTML = '';

            let foundAny = false;

            house.rooms.forEach(room => {
                // Buscamos si hay al menos una cama disponible en esta habitaci√≥n
                const availableBeds = room.beds.filter(bed => {
                    const isOccupied = reservations.some(res =>
                        res.bed_id === bed.id &&
                        res.status !== 'cancelado' &&
                        res.check_in < checkOut &&
                        res.check_out > checkIn
                    );
                    return !isOccupied;
                });

                const isFull = availableBeds.length === 0;

                const card = document.createElement('div');
                card.className = `room-option ${isFull ? 'disabled' : ''}`;
                if (isFull) card.style.opacity = "0.5";

                card.innerHTML = `
                    <h3>${room.name}</h3>
                    <p>${room.type === 'PRIVADA' ? 'Habitaci√≥n Privada' : 'Habitaci√≥n Compartida'}</p>
                    <div class="availability-badge ${isFull ? 'unavailable' : 'available'}">
                        ${isFull ? 'Agotado' : availableBeds.length + ' disponibles'}
                    </div>
                `;

                if (!isFull) {
                    card.onclick = () => selectRoom(card, availableBeds[0].id);
                }

                grid.appendChild(card);
                if (!isFull) foundAny = true;
            });

            if (!foundAny) {
                grid.innerHTML = '<p style="color: #f44336; text-align: center; width: 100%;">Lo sentimos, no hay camas disponibles para esas fechas en esta casa.</p>';
            }
        }

        function selectRoom(element, bedId) {
            document.querySelectorAll('.room-option').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            selectedBedId = bedId;

            const personal = document.getElementById('personalData');
            personal.style.opacity = "1";
            personal.style.pointerEvents = "all";
            document.getElementById('submitBtn').disabled = false;
        }

        async function submitReservation() {
            const guestName = document.getElementById('guestName').value;
            const guestEmail = document.getElementById('guestEmail').value;
            const guestPhone = document.getElementById('guestPhone').value;
            const surfLevel = document.getElementById('surfLevel').value;
            const notes = document.getElementById('notes').value;
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;
            const btn = document.getElementById('submitBtn');

            if (!guestName || !guestEmail || !guestPhone) {
                alert("Por favor completa tus datos de contacto.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> Enviando...';

            try {
                const { error } = await supabaseClient
                    .from('reservations')
                    .insert({
                        id: crypto.randomUUID(),
                        bed_id: selectedBedId,
                        guest_name: guestName,
                        guest_email: guestEmail,
                        guest_phone: guestPhone,
                        check_in: checkIn,
                        check_out: checkOut,
                        status: 'pendiente',
                        surf_level: surfLevel,
                        notes: notes,
                        payment_value: 0, // Admin definir√° el precio o se hablar√° luego
                        total_paid: 0
                    });

                if (error) throw error;

                document.getElementById('bookingForm').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('summaryDates').textContent = `${checkIn} al ${checkOut}`;

            } catch (e) {
                console.error(e);
                alert("Error al enviar la reserva. Por favor intenta de nuevo.");
                btn.disabled = false;
                btn.textContent = "Enviar solicitud de reserva";
            }
        }

        init();
    </script>
</body>

</html>