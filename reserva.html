<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu lugar - BoardXperience Surf Camp</title>
    <!-- Modern Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #10b981;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f3f4f6;
            --shadow-premium: 0 20px 40px rgba(15, 23, 42, 0.15);
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        /* Reset b√°sico */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* HERO con Video de Surfing */
        .hero {
            position: relative;
            height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: left;
            color: #ffffff;
            overflow: hidden;
        }

        .hero-slider {
            position: absolute;
            inset: 0;
            z-index: -2;
        }

        .hero-slide {
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 1.5s ease-in-out, transform 10s linear;
            background-size: cover;
            background-position: center;
            transform: scale(1.1);
        }

        .hero-slide.active {
            opacity: 1;
            transform: scale(1);
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .hero {
                height: 85vh;
                /* Taller on mobile for better immersion */
            }

            .hero-content {
                padding: 0 30px;
                text-align: center;
            }

            .hero-title {
                font-size: 2.8rem;
            }

            .hero-subtitle {
                font-size: 1.1rem;
                margin: 0 auto;
            }

            .booking-card {
                padding: 30px 20px;
                margin-top: -60px;
            }

            .house-preview-container {
                gap: 20px;
            }
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom,
                    rgba(0, 0, 0, 0.4) 0%,
                    rgba(0, 0, 0, 0.1) 60%,
                    rgba(243, 244, 246, 1) 100%);
            z-index: -1;
        }

        .hero-content {
            position: relative;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
            z-index: 1;
        }

        .hero-eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.4em;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            color: #f9d27d;
            font-weight: 700;
        }

        .hero-title {
            font-size: clamp(2.8rem, 7vw, 4.5rem);
            line-height: 1;
            margin-bottom: 1.25rem;
            font-weight: 800;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .hero-subtitle {
            max-width: 42rem;
            font-size: 1.35rem;
            opacity: 0.95;
            font-weight: 400;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        /* Layout principal */
        .container {
            max-width: 1100px;
            margin: -120px auto 50px;
            padding: 0 24px 60px;
            position: relative;
            z-index: 10;
        }

        /* Card principal */
        .booking-card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-premium);
            padding: 60px;
            transition: opacity 0.4s ease;
        }

        /* T√≠tulos pasos */
        .step-title {
            font-size: 1.4rem;
            color: var(--text-dark);
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            font-weight: 800;
            letter-spacing: -0.02em;
            gap: 12px;
        }

        .step-title span {
            color: var(--primary);
            font-size: 1.1rem;
            opacity: 0.8;
        }

        /* House Gallery Section */
        .house-preview-container {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 30px;
            margin-bottom: 50px;
        }

        @media (max-width: 768px) {
            .house-preview-container {
                grid-template-columns: 1fr;
            }
        }

        .gallery-container {
            position: relative;
            width: 100%;
            height: 350px;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: #e2e8f0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .gallery-track {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gallery-item {
            min-width: 100%;
            height: 100%;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-nav {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        .gallery-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gallery-dot.active {
            background: white;
            transform: scale(1.3);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .gallery-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .gallery-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .gallery-btn.prev {
            left: 15px;
        }

        .gallery-btn.next {
            right: 15px;
        }

        /* Form Controls */
        label {
            display: block;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 12px;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #f1f5f9;
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            background: #f8fafc;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: #ffffff;
            box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.08);
        }

        /* Room Type Grid */
        .room-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .room-option {
            background: #ffffff;
            border: 2px solid #f1f5f9;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .room-option:hover:not(.disabled) {
            border-color: var(--primary);
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }

        .room-option.active {
            border-color: var(--primary);
            background: #ffffff;
            box-shadow: 0 15px 30px -5px rgba(102, 126, 234, 0.2);
        }

        .room-image-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
        }

        .room-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .room-option:hover .room-image-container img {
            transform: scale(1.1);
        }

        .room-info {
            padding: 24px;
        }

        .room-option.full-house-option {
            grid-column: 1 / -1;
            flex-direction: row;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        @media (max-width: 768px) {
            .room-option.full-house-option {
                flex-direction: column;
            }
        }

        .room-option.full-house-option .room-image-container {
            width: 40%;
            height: auto;
            min-height: 220px;
        }

        @media (max-width: 768px) {
            .room-option.full-house-option .room-image-container {
                width: 100%;
                height: 200px;
            }
        }

        .room-option.full-house-option .room-info {
            width: 60%;
            padding: 32px;
        }

        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: #ffffff;
            border: none;
            padding: 20px 40px;
            border-radius: 999px;
            font-size: 1.05rem;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            transition: all 0.4s;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 30px -5px rgba(102, 126, 234, 0.4);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            filter: brightness(1.1);
        }

        .btn:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Success Message */
        #successMessage {
            display: none;
            text-align: center;
            padding: 80px 0;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .availability-badge {
            align-self: flex-start;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 12px;
            display: inline-block;
        }

        .available {
            background: #dcfce7;
            color: #15803d;
        }

        .unavailable {
            background: #fee2e2;
            color: #b91c1c;
        }

        .loader {
            border: 3.5px solid rgba(255, 255, 255, 0.3);
            border-top: 3.5px solid white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Calendar Styles */
        .calendar-wrapper {
            background: white;
            border-radius: var(--radius-md);
            border: 2px solid #f1f5f9;
            padding: 24px;
            margin-bottom: 30px;
        }

        .calendar-header-ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid-ui {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-ui {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }

        .calendar-day-ui:hover:not(.disabled) {
            background: #f1f5f9;
        }

        .calendar-day-ui.selected {
            background: var(--primary) !important;
            color: white !important;
        }

        .calendar-day-ui.in-range {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 0;
        }

        .calendar-day-ui.range-start {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .calendar-day-ui.range-end {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .calendar-day-ui.disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        .calendar-day-ui.today {
            border: 2px solid var(--primary);
        }

        .day-name-ui {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-light);
            padding-bottom: 12px;
            text-transform: uppercase;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>

<body>
    <!-- HERO con Video cinematico -->
    <header id="mainHero" class="hero">
        <div class="hero-slider" id="heroSlider">
            <!-- Images loaded via JS -->
        </div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <p class="hero-eyebrow">The Ultimate Surf Experience üåä</p>
            <h1 id="heroTitle" class="hero-title">BoardXperience Camp</h1>
            <p id="heroSubtitle" class="hero-subtitle">
                Donde las olas perfectas y la buena energ√≠a se encuentran. Tu mejor trip est√° por comenzar.
            </p>
            <div style="margin-top: 40px; display: flex; gap: 10px; justify-content: flex-start;"
                class="hero-controls-hint">
                <div
                    style="width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
                    <div id="heroProgress"
                        style="width: 0%; height: 100%; background: white; transition: width 5s linear;"></div>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- FORMULARIO PRINCIPAL -->
        <section class="booking-card" id="bookingForm">

            <!-- PASO 1 -->
            <h2 class="step-title"><span>01.</span> Tu Destino</h2>

            <div class="house-preview-container">
                <div class="gallery-container" id="houseGallery">
                    <button class="gallery-btn prev" onclick="moveGallery(-1)">‚ùÆ</button>
                    <button class="gallery-btn next" onclick="moveGallery(1)">‚ùØ</button>
                    <div class="gallery-track" id="galleryTrack">
                        <!-- Se carga con JS -->
                    </div>
                    <div class="gallery-nav" id="galleryNav">
                        <!-- Se carga con JS -->
                    </div>
                </div>

                <div class="house-selection-controls">
                    <div class="form-group">
                        <label for="houseSelect">Selecciona tu Casa</label>
                        <select id="houseSelect" onchange="handleHouseChange()">
                            <!-- opciones se cargan con JS -->
                        </select>
                    </div>

                    <div class="calendar-wrapper">
                        <div class="calendar-header-ui">
                            <button class="gallery-btn" onclick="changeMonth(-1)"
                                style="position: static; transform: none; width: 32px; height: 32px;">‚ùÆ</button>
                            <h3 id="calendarMonthName" style="margin: 0; font-size: 1.1rem;">Mes A√±o</h3>
                            <button class="gallery-btn" onclick="changeMonth(1)"
                                style="position: static; transform: none; width: 32px; height: 32px;">‚ùØ</button>
                        </div>
                        <div class="calendar-grid-ui" id="calendarGrid">
                            <!-- Se carga con JS -->
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.85rem; color: var(--text-light);">
                            <span id="displayCheckIn">Entrada: -</span>
                            <span id="displayCheckOut">Salida: -</span>
                        </div>
                    </div>

                    <!-- Hidden inputs for compatibility with existing logic -->
                    <input type="hidden" id="checkIn" />
                    <input type="hidden" id="checkOut" />
                </div>
            </div>

            <!-- PASO 2 -->
            <h2 class="step-title" style="margin-top: 40px;"><span>02.</span> Tu Habitaci√≥n</h2>
            <div id="roomsGrid" class="room-type-grid">
                <p
                    style="grid-column: 1 / -1; color: var(--text-light); text-align: center; padding: 60px 0; font-size: 1.1rem; border: 2px dashed #f1f5f9; border-radius: 20px;">
                    ‚ú® Selecciona tus fechas para descubrir las opciones disponibles...
                </p>
            </div>

            <!-- SERVICIOS EXTRAS -->
            <div id="extrasSection" style="margin-top: 60px; display: none;">
                <h2 class="step-title"><span>03.</span> Potenci√° tu Experiencia</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                    <div style="background: white; border-radius: 20px; overflow: hidden; border: 2px solid #f1f5f9; transition: all 0.3s;"
                        onmouseover="this.style.borderColor='var(--primary)'"
                        onmouseout="this.style.borderColor='#f1f5f9'">
                        <div style="height: 220px; overflow: hidden;">
                            <img src="fotos_reales/surf y video analisis_/Coaching.jpg.JPG"
                                style="width: 100%; height: 100%; object-fit: cover;" alt="Surf Coaching">
                        </div>
                        <div style="padding: 24px;">
                            <h3 style="margin-bottom: 10px; color: var(--text-dark);">Surf Coaching Pro</h3>
                            <p style="color: var(--text-light); font-size: 0.95rem;">Perfeccion√° tu t√©cnica con nuestros
                                instructores certificados. Sesiones personalizadas en el agua.</p>
                        </div>
                    </div>
                    <div style="background: white; border-radius: 20px; overflow: hidden; border: 2px solid #f1f5f9; transition: all 0.3s;"
                        onmouseover="this.style.borderColor='var(--primary)'"
                        onmouseout="this.style.borderColor='#f1f5f9'">
                        <div style="height: 220px; overflow: hidden;">
                            <img src="fotos_reales/surf y video analisis_/Videoanalisis.jpg.JPG"
                                style="width: 100%; height: 100%; object-fit: cover;" alt="Video Analisis">
                        </div>
                        <div style="padding: 24px;">
                            <h3 style="margin-bottom: 10px; color: var(--text-dark);">Video An√°lisis</h3>
                            <p style="color: var(--text-light); font-size: 0.95rem;">Mir√° tus olas, correg√≠ errores y
                                evolucion√° m√°s r√°pido. La herramienta clave para subir de nivel.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PASO 4 -->
            <section id="personalData"
                style="opacity: 0.2; pointer-events: none; transition: all 0.6s; border-top: 2px solid #f1f5f9; padding-top: 60px; margin-top: 20px;">
                <h2 class="step-title"><span>04.</span> Detalles Personales</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="guestName">Nombre de la Reserva</label>
                        <input type="text" id="guestName" placeholder="Tu nombre completo" />
                    </div>
                    <div class="form-group">
                        <label for="guestEmail">Correo Electr√≥nico</label>
                        <input type="email" id="guestEmail" placeholder="email@ejemplo.com" />
                    </div>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label for="guestPhone">WhatsApp / Tel√©fono</label>
                        <input type="tel" id="guestPhone" placeholder="+54 9 11 ..." />
                    </div>
                    <div class="form-group">
                        <label for="surfLevel">¬øCu√°l es tu nivel de Surf?</label>
                        <select id="surfLevel" onchange="updateSurfLevelPreview()">
                            <option value="principiante">üèÑ‚Äç‚ôÇÔ∏è Principiante (Quiero aprender)</option>
                            <option value="intermedio">üåä Intermedio (Ya me paro)</option>
                            <option value="avanzado">üî• Avanzado (Le doy a todo)</option>
                        </select>
                        <div id="surfLevelPreview"
                            style="margin-top: 15px; border-radius: 12px; overflow: hidden; height: 120px; display: none; border: 2px solid #f1f5f9;">
                            <img src="" id="surfLevelImg" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Mensaje o preferencias especiales</label>
                    <textarea id="notes" rows="4"
                        placeholder="Contanos algo m√°s sobre tu viaje o si ten√©s alguna alergia/preferencia..."></textarea>
                </div>

                <div style="margin-top: 60px;">
                    <button id="submitBtn" class="btn" onclick="submitReservation()" disabled>
                        Confirmar Solicitud de Reserva
                    </button>
                </div>
            </section>
        </section>

        <!-- MENSAJE √âXITO -->
        <section id="successMessage" class="booking-card" style="padding: 0; overflow: hidden;">
            <div style="height: 250px; position: relative;">
                <img src="fotos_reales/Dron_/localizacion_panoramica.jpg.jpg"
                    style="width: 100%; height: 100%; object-fit: cover;" alt="Success">
                <div style="position: absolute; inset: 0; background: linear-gradient(transparent, white);"></div>
                <span
                    style="font-size: 5rem; position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%);">ü§ô</span>
            </div>
            <div style="padding: 60px 40px 80px; text-align: center;">
                <h2 style="font-size: 2rem; margin-bottom: 16px;">¬°Tu lugar est√° casi listo!</h2>
                <p>
                    Recibimos tu solicitud para las fechas: <br>
                    <strong id="summaryDates"
                        style="color: var(--text-dark); background: #fef3c7; padding: 4px 12px; border-radius: 8px;"></strong>
                </p>
                <p>Nos pondremos en contacto contigo v√≠a WhatsApp para confirmar los detalles finales.</p>
                <button class="btn" onclick="location.reload()" style="max-width: 320px; margin: 40px auto 0;">
                    Hacer otra reserva
                </button>
        </section>
    </main>

    <script>
        let reservations = [];
        let selectedBedId = null;
        let isFullHouseSelection = false;
        let selectedHouseId = null;
        let houses = [];
        let currentGalleryIndex = 0;
        let galleryImages = [];

        // Calendar variables
        let calendarDate = new Date();
        let rangeStart = null;
        let rangeEnd = null;

        async function init() {
            try {
                const { data: houseData, error: hErr } = await supabaseClient
                    .from('houses')
                    .select('*, rooms(*, beds(*))');

                if (hErr) throw hErr;
                houses = houseData;

                const select = document.getElementById('houseSelect');
                houses.forEach((h, i) => {
                    const opt = document.createElement('option');
                    opt.value = h.id;
                    opt.textContent = `${h.icon || 'üè†'} ${h.name}`;
                    if (i === 0) opt.selected = true;
                    select.appendChild(opt);
                });

                if (houses.length > 0) handleHouseChange();

                const { data: resData } = await supabaseClient.from('reservations').select('*');
                if (resData) reservations = resData;

                renderCalendar();
            } catch (e) {
                console.error(e);
                alert("Error cargando el sistema.");
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthName = document.getElementById('calendarMonthName');
            grid.innerHTML = '';

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            monthName.textContent = `${months[month]} ${year}`;

            ['D', 'L', 'M', 'M', 'J', 'V', 'S'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'day-name-ui';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            });

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day-ui';
                dayEl.textContent = d;

                if (date < today) {
                    dayEl.classList.add('disabled');
                } else {
                    dayEl.onclick = () => handleDateClick(date);

                    if (rangeStart && date.getTime() === rangeStart.getTime()) dayEl.classList.add('selected', 'range-start');
                    if (rangeEnd && date.getTime() === rangeEnd.getTime()) dayEl.classList.add('selected', 'range-end');
                    if (rangeStart && rangeEnd && date > rangeStart && date < rangeEnd) {
                        dayEl.classList.add('in-range');
                    }
                }

                if (date.getTime() === today.getTime()) dayEl.classList.add('today');
                grid.appendChild(dayEl);
            }
        }

        function handleDateClick(date) {
            if (!rangeStart || (rangeStart && rangeEnd)) {
                rangeStart = date;
                rangeEnd = null;
            } else if (date < rangeStart) {
                rangeStart = date;
            } else if (date.getTime() === rangeStart.getTime()) {
                rangeStart = null;
            } else {
                rangeEnd = date;
            }

            updateDateInputs();
            renderCalendar();
            checkAvailability();
        }

        function updateDateInputs() {
            const startInput = document.getElementById('checkIn');
            const endInput = document.getElementById('checkOut');
            const startDisplay = document.getElementById('displayCheckIn');
            const endDisplay = document.getElementById('displayCheckOut');

            if (rangeStart) {
                const dateStr = rangeStart.toISOString().split('T')[0];
                startInput.value = dateStr;
                startDisplay.textContent = `Entrada: ${rangeStart.toLocaleDateString()}`;
            } else {
                startInput.value = '';
                startDisplay.textContent = 'Entrada: -';
            }

            if (rangeEnd) {
                const dateStr = rangeEnd.toISOString().split('T')[0];
                endInput.value = dateStr;
                endDisplay.textContent = `Salida: ${rangeEnd.toLocaleDateString()}`;
            } else {
                endInput.value = '';
                endDisplay.textContent = 'Salida: -';
            }
        }

        function changeMonth(step) {
            calendarDate.setMonth(calendarDate.getMonth() + step);
            renderCalendar();
        }

        function handleHouseChange() {
            const houseId = document.getElementById('houseSelect').value;
            selectedHouseId = houseId;
            const house = houses.find(h => h.id == houseId);

            // Simular multiples fotos por casa (en el futuro vendr√° de DB)
            // Mapeo de fotos reales por casa
            const housePhotos = {
                // BoardXperience House
                '1': [
                    'fotos_reales/BoardXperienceHouse/Fachada.jpg.jpg',
                    'fotos_reales/BoardXperienceHouse/sala_principal.jpg.jpg',
                    'fotos_reales/BoardXperienceHouse/sala.jpg.jpg',
                    'fotos_reales/BoardXperienceHouse/cozinha.jpg.jpg',
                    'fotos_reales/BoardXperienceHouse/quarto_casal.jpg.jpg',
                    'fotos_reales/BoardXperienceHouse/quarto_triple.jpg.jpg',
                    'fotos_reales/social exterior/FRA08633.JPG'
                ],
                // Casa Vista Mar (Usando compartidas y dron por ahora)
                '2': [
                    'fotos_reales/Dron_/vista_casa_arriba.jpg.JPG',
                    'fotos_reales/BoardXperienceHouse/Fachada.jpg.jpg',
                    'fotos_reales/Dron_/panoramica.jpg.jpg',
                    'fotos_reales/social exterior/FRA08638.JPG',
                    'fotos_reales/social exterior/FRA06755.JPG',
                    'fotos_reales/Dron_/lagoa_atras_da_praia.jpg.JPG'
                ]
            };

            galleryImages = housePhotos[houseId] || [
                house.image_url || 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=1200&q=80',
                'https://images.unsplash.com/photo-1590490360182-c33d57733427?auto=format&fit=crop&w=1200&q=80',
                'https://images.unsplash.com/photo-1542718610-a1d656d1884c?auto=format&fit=crop&w=1200&q=80'
            ];

            updateGallery();
            document.getElementById('heroTitle').textContent = house.name;
            checkAvailability();
        }

        function updateGallery() {
            const track = document.getElementById('galleryTrack');
            const nav = document.getElementById('galleryNav');
            currentGalleryIndex = 0;

            track.innerHTML = galleryImages.map(img => `
                <div class="gallery-item">
                    <img src="${img}" alt="House detail" onerror="this.src='https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=1200&q=80'">
                </div>
            `).join('');

            nav.innerHTML = galleryImages.map((_, i) => `
                <button class="gallery-dot ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></button>
            `).join('');

            track.style.transform = `translateX(0)`;
        }

        function moveGallery(step) {
            currentGalleryIndex = (currentGalleryIndex + step + galleryImages.length) % galleryImages.length;
            goToSlide(currentGalleryIndex);
        }

        function goToSlide(index) {
            currentGalleryIndex = index;
            const track = document.getElementById('galleryTrack');
            if (track) track.style.transform = `translateX(-${index * 100}%)`;

            const dots = document.querySelectorAll('.gallery-dot');
            dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
        }

        async function checkAvailability() {
            const startStr = document.getElementById('checkIn').value;
            const endStr = document.getElementById('checkOut').value;
            if (!startStr || !endStr || !selectedHouseId) return;

            const grid = document.getElementById('roomsGrid');
            const house = houses.find(h => String(h.id) === String(selectedHouseId));
            if (!house) return;

            const { data: freshRes } = await supabaseClient.from('reservations').select('*');
            if (freshRes) reservations = freshRes;

            grid.innerHTML = '';

            // CASA COMPLETA
            let allBeds = [];
            house.rooms.forEach(r => { if (r.beds) allBeds.push(...r.beds); });

            const bedsOccupied = allBeds.filter(bed =>
                reservations.some(res =>
                    res.bed_id === bed.id &&
                    res.status !== 'cancelado' &&
                    res.check_in < endStr &&
                    res.check_out > startStr
                )
            );

            const isFullHouseAvailable = allBeds.length > 0 && bedsOccupied.length === 0;

            const fhCard = document.createElement('div');
            fhCard.className = `room-option full-house-option ${!isFullHouseAvailable ? 'disabled' : ''}`;

            fhCard.innerHTML = `
                <div class="room-image-container">
                    <img src="fotos_reales/Dron_/panoramica.jpg.jpg" alt="Full camp">
                </div>
                <div class="room-info">
                    <div class="availability-badge ${isFullHouseAvailable ? 'available' : 'unavailable'}">
                        ${isFullHouseAvailable ? '‚ú® ¬°Exclusivo! Disponible' : 'üîí Parcialmente reservado'}
                    </div>
                    <h3 style="color: white;">EXPERIENCIA CASA COMPLETA</h3>
                    <p style="color: rgba(255,255,255,0.9);">
                        ${isFullHouseAvailable
                    ? 'Reserva todo el resort para tu grupo. Privacidad absoluta y staff dedicado.'
                    : 'Esta opci√≥n no est√° disponible completa porque hay habitaciones ya reservadas en este periodo.'}
                    </p>
                </div>
            `;

            if (isFullHouseAvailable) {
                fhCard.onclick = () => selectFullHouse(fhCard);
            } else {
                fhCard.style.opacity = '0.6';
                fhCard.style.filter = 'grayscale(0.3)';
                fhCard.style.cursor = 'not-allowed';
            }
            grid.appendChild(fhCard);

            house.rooms.forEach(room => {
                const availableBeds = room.beds ? room.beds.filter(bed => !reservations.some(res => res.bed_id === bed.id && res.status !== 'cancelado' && res.check_in < endStr && res.check_out > startStr)) : [];
                const isFull = availableBeds.length === 0;

                // L√≥gica de im√°genes realistas
                let roomImg = room.image_url;
                const isPrincipalHouse = String(selectedHouseId) === '1';

                if (isPrincipalHouse) {
                    if (room.name.toLowerCase().includes('triple')) roomImg = 'fotos_reales/BoardXperienceHouse/quarto_triple.jpg.jpg';
                    else if (room.name.toLowerCase().includes('doble') || room.name.toLowerCase().includes('casal')) roomImg = 'fotos_reales/BoardXperienceHouse/quarto_casal.jpg.jpg';
                }

                // Fallback inteligente: No usar fotos de la casa principal para otras casas
                if (!roomImg) {
                    if (isPrincipalHouse) {
                        roomImg = 'fotos_reales/BoardXperienceHouse/sala_principal.jpg.jpg';
                    } else {
                        // Para otras casas, usar fotos de dron o exteriores generales
                        roomImg = 'fotos_reales/Dron_/vista_casa_arriba.jpg.JPG';
                    }
                }

                const card = document.createElement('div');
                card.className = `room-option ${isFull ? 'disabled' : ''}`;
                card.innerHTML = `
                    <div class="room-image-container">
                        <img src="${roomImg}" alt="${room.name}" onerror="this.src='https://images.unsplash.com/photo-1590490360182-c33d57733427?auto=format&fit=crop&w=1200&q=80'">
                    </div>
                    <div class="room-info">
                        <div class="availability-badge ${isFull ? 'unavailable' : 'available'}">${isFull ? 'Ocupado' : availableBeds.length + ' libres'}</div>
                        <h3>${room.name}</h3>
                        <p>${room.type === 'PRIVADA' ? 'üõå Habitaci√≥n Privada' : 'üë• Habitaci√≥n Compartida'}</p>
                    </div>
                `;
                if (!isFull) card.onclick = () => selectRoom(card, availableBeds[0].id);
                grid.appendChild(card);
            });
        }

        function selectRoom(el, id) {
            document.querySelectorAll('.room-option').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            selectedBedId = id; isFullHouseSelection = false; enablePersonalData();
        }

        function selectFullHouse(el) {
            document.querySelectorAll('.room-option').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            isFullHouseSelection = true; selectedBedId = null; enablePersonalData();
        }

        function enablePersonalData() {
            const p = document.getElementById('personalData');
            const extras = document.getElementById('extrasSection');
            p.style.opacity = "1"; p.style.pointerEvents = "all";
            extras.style.display = "block";
            document.getElementById('submitBtn').disabled = false;
        }

        async function submitReservation() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loader"></span> Procesando...';

            try {
                const groupId = isFullHouseSelection ? crypto.randomUUID() : null;
                const house = houses.find(h => h.id == selectedHouseId);
                let beds = isFullHouseSelection ? house.rooms.flatMap(r => r.beds) : [{ id: selectedBedId }];

                for (const bed of beds) {
                    await supabaseClient.from('reservations').insert({
                        id: crypto.randomUUID(),
                        bed_id: bed.id,
                        guest_name: isFullHouseSelection ? `${document.getElementById('guestName').value} (GRUPO)` : document.getElementById('guestName').value,
                        guest_email: document.getElementById('guestEmail').value,
                        guest_phone: document.getElementById('guestPhone').value,
                        check_in: document.getElementById('checkIn').value,
                        check_out: document.getElementById('checkOut').value,
                        status: 'pendiente',
                        surf_level: document.getElementById('surfLevel').value,
                        notes: document.getElementById('notes').value,
                        full_house_group_id: groupId
                    });
                }
                document.getElementById('bookingForm').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('summaryDates').textContent = `${document.getElementById('checkIn').value} al ${document.getElementById('checkOut').value}`;
            } catch (e) {
                btn.disabled = false; btn.innerHTML = 'Confirmar';
            }
        }
        function updateSurfLevelPreview() {
            const level = document.getElementById('surfLevel').value;
            const preview = document.getElementById('surfLevelPreview');
            const img = document.getElementById('surfLevelImg');

            const levelPhotos = {
                'principiante': 'fotos_reales/surf y video analisis_/alumna_jpg.JPG',
                'intermedio': 'fotos_reales/surf y video analisis_/nivel_intermedio.jpg.jpg',
                'avanzado': 'fotos_reales/surf y video analisis_/nivel_avanzado.jpg.JPG'
            };

            if (levelPhotos[level]) {
                img.src = levelPhotos[level];
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // Hero Slider Logic
        const dronePhotos = [
            'fotos_reales/Dron_/panoramica.jpg.jpg',
            'fotos_reales/Dron_/vista_casa_arriba.jpg.JPG',
            'fotos_reales/Dron_/dji_fly_20241218_075542_123_1734519435580_photo_optimized.jpg',
            'fotos_reales/Dron_/lagoa_atras_da_praia.jpg.JPG',
            'fotos_reales/Dron_/localizacion_panoramica.jpg.jpg',
            'fotos_reales/Dron_/localiza√ßao.jpg.jpg'
        ];

        let currentHeroIndex = 0;

        function initHeroSlider() {
            const slider = document.getElementById('heroSlider');
            slider.innerHTML = dronePhotos.map((img, i) => `
                <div class="hero-slide ${i === 0 ? 'active' : ''}" style="background-image: url('${img}')"></div>
            `).join('');

            setInterval(nextHeroSlide, 5000);
            updateProgress();
        }

        function nextHeroSlide() {
            const slides = document.querySelectorAll('.hero-slide');
            slides[currentHeroIndex].classList.remove('active');
            currentHeroIndex = (currentHeroIndex + 1) % dronePhotos.length;
            slides[currentHeroIndex].classList.add('active');
            updateProgress();
        }

        function updateProgress() {
            const progress = document.getElementById('heroProgress');
            if (!progress) return;
            progress.style.transition = 'none';
            progress.style.width = '0%';
            setTimeout(() => {
                progress.style.transition = 'width 5s linear';
                progress.style.width = '100%';
            }, 50);
        }

        // Parallax scroll effect
        window.addEventListener('scroll', () => {
            const scrolled = window.scrollY;
            const hero = document.getElementById('mainHero');
            const slider = document.getElementById('heroSlider');
            if (slider) {
                slider.style.transform = `translateY(${scrolled * 0.4}px)`;
            }
        });

        init();
        initHeroSlider();
    </script>
</body>

</html>