<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoardXperience - Sistema de Reservas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .houses-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .house-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .house-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .house-title {
            font-size: 22px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .house-icon {
            font-size: 24px;
        }

        .calendar {
            margin-top: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .month-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            min-width: 150px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 8px;
            font-size: 12px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 70px;
        }

        .calendar-day:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: #fff4e6;
            border-color: #ff9800;
        }

        .day-number {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .beds-indicator {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .bed-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }

        .bed-dot.occupied {
            background: #f44336;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 22px;
            color: #333;
            margin-bottom: 5px;
        }

        .modal-subtitle {
            color: #666;
            font-size: 14px;
        }

        .beds-grid {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }

        .bed-item {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .bed-item:hover {
            border-color: #667eea;
        }

        .bed-item.occupied {
            background: #ffebee;
            border-color: #f44336;
        }

        .bed-item.available {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .bed-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .bed-name {
            font-weight: 600;
            color: #333;
        }

        .guest-name {
            font-size: 13px;
            color: #666;
        }

        .bed-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .payment-section {
            background: #f9fafb;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .payment-label {
            font-weight: 600;
            color: #666;
            font-size: 14px;
        }

        .payment-value {
            font-weight: 700;
            font-size: 16px;
        }

        .payment-value.pending {
            color: #f44336;
        }

        .payment-value.paid {
            color: #4caf50;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .btn-block {
            flex: 1;
        }

        @media (max-width: 768px) {
            .houses-container {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                min-height: 60px;
            }

            .day-number {
                font-size: 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>üè† BoardXperience - Sistema de Reservas</h1>
            <p class="subtitle">Gesti√≥n de hu√©spedes y disponibilidad de casas</p>
        </header>

        <div class="controls">
            <button class="btn btn-primary" onclick="app.showNewReservation()">‚ûï Nueva Reserva</button>
            <button class="btn btn-secondary" onclick="app.exportData()">üíæ Exportar Datos</button>
            <button class="btn btn-secondary" onclick="app.importData()">üìÇ Importar Datos</button>
        </div>

        <div class="houses-container" id="housesContainer"></div>
    </div>

    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nueva Reserva</h2>
                <p class="modal-subtitle" id="modalSubtitle"></p>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const app = {
            houses: [
                {
                    id: 1,
                    name: 'BoardXperience House',
                    icon: 'üè°',
                    subtitle: 'Casa principal con habitaciones compartidas y privadas',
                    rooms: [
                        { id: 1, name: 'Dormitorio Triple', type: 'COMPARTIDA', beds: ['Cama Individual 1', 'Cama Individual 2', 'Cama 3'] },
                        { id: 2, name: 'Cuarto Cama Doble', type: 'PRIVADA', beds: ['Cama Doble'] }
                    ]
                },
                {
                    id: 2,
                    name: 'Casa Vista Mar',
                    icon: 'üèòÔ∏è',
                    subtitle: 'Cabanha vista mar',
                    rooms: [
                        { id: 3, name: 'Dormitorio Doble', type: 'COMPARTIDA', beds: ['cama doble'] },
                        { id: 4, name: 'casal', type: 'PRIVADA', beds: ['cama 1'] }
                    ]
                }
            ],
            currentMonth: new Date(),
            reservations: JSON.parse(localStorage.getItem('boardxperience_reservations') || '[]'),

            async init() {
                console.log('Iniciando aplicaci√≥n...');
                await this.loadFromSupabase();
                this.render();
            },

            async loadFromSupabase() {
                try {
                    // Cargar casas
                    const { data: houses, error: housesError } = await supabaseClient
                        .from('houses')
                        .select('*, rooms(*, beds(*))');

                    if (housesError) throw housesError;
                    if (houses && houses.length > 0) {
                        this.houses = houses.map(h => ({
                            id: h.id,
                            name: h.name,
                            icon: h.icon,
                            subtitle: h.subtitle,
                            rooms: h.rooms.map(r => ({
                                id: r.id,
                                name: r.name,
                                type: r.type,
                                beds: r.beds.map(b => ({ id: b.id, name: b.name }))
                            }))
                        }));
                    } else {
                        // Si no hay casas en Supabase, iniciar migraci√≥n autom√°tica de datos base
                        console.log('No se encontraron casas, iniciando migraci√≥n autom√°tica...');
                        await this.migrateInitialDataToSupabase();
                        return; // migrateInitialDataToSupabase recarga la p√°gina
                    }

                    // Cargar reservas
                    const { data: reservations, error: resError } = await supabaseClient
                        .from('reservations')
                        .select('*');

                    if (resError) throw resError;
                    if (reservations) {
                        this.reservations = reservations.map(r => {
                            // Reconstruir la relaci√≥n con la casa y habitaci√≥n para el calendario
                            let houseId, roomId, bedIndex, bedName;
                            for (const h of this.houses) {
                                for (const room of h.rooms) {
                                    const index = room.beds.findIndex(b => b.id === r.bed_id);
                                    if (index !== -1) {
                                        houseId = h.id;
                                        roomId = room.id;
                                        bedIndex = index;
                                        bedName = room.beds[index].name;
                                        break;
                                    }
                                }
                                if (houseId) break;
                            }

                            return {
                                id: r.id,
                                bedId: r.bed_id,
                                houseId,
                                roomId,
                                bedIndex,
                                bedName,
                                guestName: r.guest_name,
                                email: r.guest_email,
                                phone: r.guest_phone,
                                checkIn: r.check_in,
                                checkOut: r.check_out,
                                status: r.status,
                                paymentValue: r.payment_value,
                                deposit: r.deposit,
                                totalPaid: r.total_paid,
                                packageType: r.package_type,
                                surfLevel: r.surf_level,
                                packageDays: r.package_days,
                                notes: r.notes
                            };
                        });
                    }
                } catch (error) {
                    console.error('Error cargando desde Supabase:', error);
                    alert('No se pudo conectar con Supabase. Usando datos locales.');
                }
            },

            render() {
                const container = document.getElementById('housesContainer');
                container.innerHTML = this.houses.map(house => this.renderHouse(house)).join('');
            },

            renderHouse(house) {
                const totalBeds = house.rooms.reduce((sum, room) => sum + room.beds.length, 0);
                return `
                    <div class="house-card">
                        <div class="house-header">
                            <h2 class="house-title">
                                <span class="house-icon">${house.icon}</span>
                                ${house.name}
                            </h2>
                            <span style="color: #666; font-size: 14px;">${totalBeds} camas</span>
                        </div>
                        <div style="margin-bottom: 15px; color: #666; font-size: 13px;">${house.subtitle}</div>
                        ${this.renderRooms(house)}
                        ${this.renderCalendar(house)}
                    </div>
                `;
            },

            renderRooms(house) {
                return `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        ${house.rooms.map(room => `
                            <div style="background: #f9fafb; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="font-weight: 600; color: #333;">üõèÔ∏è ${room.name}</span>
                                    <span style="background: ${room.type === 'PRIVADA' ? '#dbeafe' : '#fef3c7'}; color: ${room.type === 'PRIVADA' ? '#1e40af' : '#92400e'}; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${room.type}</span>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${room.beds.map((bed, index) => {
                    const today = new Date().toISOString().split('T')[0];
                    const reservation = this.reservations.find(r =>
                        r.bedId === bed.id &&
                        r.checkIn <= today &&
                        r.checkOut >= today
                    );
                    const isAvailable = !reservation;
                    return `
                                            <div onclick="app.handleBedClick(${house.id}, ${room.id}, ${index}, '${bed.name}', '${bed.id}')" style="cursor: pointer; padding: 10px; background: white; border: 2px solid ${isAvailable ? '#10b981' : '#ef4444'}; border-radius: 8px; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                                <span style="font-size: 18px;">üõèÔ∏è</span>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 14px; color: #333;">${bed.name}</div>
                                                    <div style="font-size: 12px; color: ${isAvailable ? '#10b981' : '#ef4444'}; display: flex; align-items: center; gap: 4px;">
                                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${isAvailable ? '#10b981' : '#ef4444'};"></span>
                                                        ${isAvailable ? 'Disponible' : reservation.guestName}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                }).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            handleBedClick(houseId, roomId, bedIndex, bedName, bedId) {
                const today = new Date().toISOString().split('T')[0];
                const reservation = this.reservations.find(r =>
                    r.bedId === bedId &&
                    r.checkIn <= today &&
                    r.checkOut >= today
                );

                if (reservation) {
                    this.editReservation(reservation.id);
                } else {
                    this.showReservationForm(houseId, today, roomId, bedIndex, bedName, null, bedId);
                }
            },

            renderCalendar(house) {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startingDayOfWeek = firstDay.getDay();

                const monthName = firstDay.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

                let html = `
                    <div class="calendar">
                        <div class="calendar-header">
                            <div class="month-nav">
                                <button class="btn btn-secondary" onclick="app.previousMonth()">‚óÄ</button>
                                <span class="month-title">${monthName}</span>
                                <button class="btn btn-secondary" onclick="app.nextMonth()">‚ñ∂</button>
                            </div>
                            <button class="btn btn-primary" onclick="app.currentMonthView()">Hoy</button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-day-header">Dom</div>
                            <div class="calendar-day-header">Lun</div>
                            <div class="calendar-day-header">Mar</div>
                            <div class="calendar-day-header">Mi√©</div>
                            <div class="calendar-day-header">Jue</div>
                            <div class="calendar-day-header">Vie</div>
                            <div class="calendar-day-header">S√°b</div>
                `;

                // Previous month days
                for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                    html += `<div class="calendar-day other-month"></div>`;
                }

                // Current month days
                const today = new Date();
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = date.toDateString() === today.toDateString();
                    const bedStatus = this.getBedStatus(house.id, dateStr);

                    html += `
                        <div class="calendar-day ${isToday ? 'today' : ''}" onclick="app.openDayView(${house.id}, '${dateStr}')">
                            <div class="day-number">${day}</div>
                            <div class="beds-indicator">
                                ${this.renderBedDots(bedStatus, house.id)}
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #4caf50;"></div>
                                <span>Disponible</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #ff9800;"></div>
                                <span>Parcial</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #f44336;"></div>
                                <span>Ocupada</span>
                            </div>
                        </div>
                    </div>
                `;

                return html;
            },

            getBedStatus(houseId, date) {
                const reservations = this.reservations.filter(r =>
                    r.houseId === houseId &&
                    r.checkIn <= date &&
                    r.checkOut >= date
                );
                return reservations;
            },

            getTotalBedsForHouse(houseId) {
                const house = this.houses.find(h => h.id === houseId);
                return house.rooms.reduce((sum, room) => sum + room.beds.length, 0);
            },

            renderBedDots(reservations, houseId) {
                const totalBeds = this.getTotalBedsForHouse(houseId);
                const occupiedBeds = reservations.length;
                let html = '';

                for (let i = 0; i < totalBeds; i++) {
                    if (i < occupiedBeds) {
                        html += '<div class="bed-dot occupied"></div>';
                    } else {
                        html += '<div class="bed-dot"></div>';
                    }
                }

                return html;
            },

            openDayView(houseId, date) {
                const house = this.houses.find(h => h.id === houseId);
                const reservations = this.getBedStatus(houseId, date);
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                document.getElementById('modalTitle').textContent = house.name;
                document.getElementById('modalSubtitle').textContent = formattedDate;

                let bedsHtml = '<div style="margin-bottom: 20px;">';

                house.rooms.forEach(room => {
                    bedsHtml += `
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                <span>üõèÔ∏è ${room.name}</span>
                                <span style="background: ${room.type === 'PRIVADA' ? '#dbeafe' : '#fef3c7'}; color: ${room.type === 'PRIVADA' ? '#1e40af' : '#92400e'}; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${room.type}</span>
                            </div>
                            <div class="beds-grid">
                    `;

                    room.beds.forEach((bed, bedIndex) => {
                        const reservation = reservations.find(r => r.bedId === bed.id);
                        const isOccupied = !!reservation;

                        bedsHtml += `
                            <div class="bed-item ${isOccupied ? 'occupied' : 'available'}">
                                <div class="bed-info">
                                    <div class="bed-name">${bed.name}</div>
                                    ${isOccupied ? `<div class="guest-name">${reservation.guestName}</div>` : ''}
                                </div>
                                ${isOccupied ?
                                `<button class="btn btn-primary" onclick="app.editReservation('${reservation.id}')">Ver/Editar</button>` :
                                `<button class="btn btn-primary" onclick="app.showReservationForm(${houseId}, '${date}', ${room.id}, ${bedIndex}, '${bed.name}', null, '${bed.id}')">Reservar</button>`
                            }
                            </div>
                        `;
                    });

                    bedsHtml += `
                            </div>
                        </div>
                    `;
                });

                bedsHtml += '</div>';

                bedsHtml += `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary btn-block" onclick="app.bookFullHouse(${houseId}, '${date}')">
                            üè† Reservar Casa Completa
                        </button>
                    </div>
                `;

                document.getElementById('modalBody').innerHTML = bedsHtml;
                document.getElementById('reservationModal').classList.add('active');
            },

            showReservationForm(houseId, checkInDate, roomId, bedIndex, bedName, existingReservation = null, bedId = null) {
                const house = this.houses.find(h => h.id === houseId);
                const room = house.rooms.find(r => r.id === roomId);
                const isEdit = !!existingReservation;
                const effectiveBedId = bedId || (existingReservation ? existingReservation.bedId : null);

                document.getElementById('modalTitle').textContent = isEdit ? 'Editar Reserva' : 'Nueva Reserva';
                document.getElementById('modalSubtitle').textContent = `${house.name} - ${room.name} - ${bedName}`;

                const res = existingReservation || {};

                let formHtml = `
                    <form id="reservationForm">
                        <div class="form-section">
                            <div class="section-title">‚öôÔ∏è Informaci√≥n del Slot</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N√∫mero de Slot</label>
                                    <input type="text" value="${house.name} - ${room.name} - ${bedName}" readonly style="background: #f3f4f6;">
                                </div>
                                <div class="form-group">
                                    <label>Estado del Slot</label>
                                    <select id="slotStatus">
                                        <option value="libre" ${!isEdit ? 'selected' : ''}>Libre</option>
                                        <option value="ocupado" ${isEdit ? 'selected' : ''}>Ocupado</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">üë§ Datos del Hu√©sped</div>
                            <div class="form-group">
                                <label>Nombre del Hu√©sped *</label>
                                <input type="text" id="guestName" placeholder="Ej: Lucas Acosta" value="${res.guestName || ''}" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="guestEmail" placeholder="lucas@ejemplo.com" value="${res.email || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Tel√©fono</label>
                                    <input type="tel" id="guestPhone" placeholder="+54 9 11 12345678" value="${res.phone || ''}">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">üèÑ Informaci√≥n del Paquete</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de Paquete</label>
                                    <select id="packageType">
                                        <option value="">Seleccionar paquete</option>
                                        <option value="basico" ${res.packageType === 'basico' ? 'selected' : ''}>B√°sico</option>
                                        <option value="intermedio" ${res.packageType === 'intermedio' ? 'selected' : ''}>Intermedio</option>
                                        <option value="completo" ${res.packageType === 'completo' ? 'selected' : ''}>Completo</option>
                                        <option value="premium" ${res.packageType === 'premium' ? 'selected' : ''}>Premium</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Nivel de Surf</label>
                                    <select id="surfLevel">
                                        <option value="">Seleccionar nivel</option>
                                        <option value="principiante" ${res.surfLevel === 'principiante' ? 'selected' : ''}>Principiante</option>
                                        <option value="intermedio" ${res.surfLevel === 'intermedio' ? 'selected' : ''}>Intermedio</option>
                                        <option value="avanzado" ${res.surfLevel === 'avanzado' ? 'selected' : ''}>Avanzado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>D√≠as del Paquete</label>
                                <input type="number" id="packageDays" min="1" placeholder="7" value="${res.packageDays || ''}">
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">üìÖ Fechas</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Check-in *</label>
                                    <input type="date" id="checkIn" value="${res.checkIn || checkInDate}" required>
                                </div>
                                <div class="form-group">
                                    <label>Check-out *</label>
                                    <input type="date" id="checkOut" value="${res.checkOut || ''}" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">üí∞ Pagos</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Precio Total (R$)</label>
                                    <input type="number" id="totalPrice" min="0" step="0.01" placeholder="0.00" value="${res.totalPrice || ''}" onchange="app.calculateBalance()">
                                </div>
                                <div class="form-group">
                                    <label>Se√±a/Anticipo (R$)</label>
                                    <input type="number" id="deposit" min="0" step="0.01" placeholder="0.00" value="${res.deposit || ''}" onchange="app.calculateBalance()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Total Pagado (R$)</label>
                                <input type="number" id="totalPaid" min="0" step="0.01" placeholder="0.00" value="${res.totalPaid || ''}" onchange="app.calculateBalance()">
                            </div>
                            <div class="payment-section">
                                <div class="payment-row">
                                    <span class="payment-label">Precio Total:</span>
                                    <span class="payment-value" id="displayTotal">R$ 0.00</span>
                                </div>
                                <div class="payment-row">
                                    <span class="payment-label">Total Pagado:</span>
                                    <span class="payment-value paid" id="displayPaid">R$ 0.00</span>
                                </div>
                                <div class="payment-row" style="border-top: 2px solid #e0e0e0; padding-top: 10px; margin-top: 5px;">
                                    <span class="payment-label" style="font-size: 15px;">Saldo Pendiente:</span>
                                    <span class="payment-value pending" id="displayBalance" style="font-size: 17px;">R$ 0.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">üìù Notas</div>
                            <div class="form-group">
                                <textarea id="notes" rows="3" placeholder="Notas adicionales sobre la reserva...">${res.notes || ''}</textarea>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-block" onclick="app.closeModal()">Cancelar</button>
                            ${isEdit ? `<button type="button" class="btn btn-danger btn-block" onclick="app.deleteReservation(${res.id})">Eliminar</button>` : ''}
                            <button type="submit" class="btn btn-primary btn-block">${isEdit ? 'Actualizar' : 'Guardar'}</button>
                        </div>
                    </form>
                `;

                document.getElementById('modalBody').innerHTML = formHtml;

                // Setup form submit
                document.getElementById('reservationForm').onsubmit = (e) => {
                    e.preventDefault();
                    this.saveReservation(houseId, roomId, bedIndex, bedName, isEdit ? res.id : null, effectiveBedId);
                };

                // Calculate balance on load
                setTimeout(() => this.calculateBalance(), 100);

                document.getElementById('reservationModal').classList.add('active');
            },

            editReservation(reservationId) {
                const reservation = this.reservations.find(r => r.id === reservationId);
                if (reservation) {
                    const house = this.houses.find(h => h.id === reservation.houseId);
                    const room = house.rooms.find(r => r.id === reservation.roomId);
                    const bed = room.beds[reservation.bedIndex];
                    this.showReservationForm(reservation.houseId, reservation.checkIn, reservation.roomId, reservation.bedIndex, bed.name, reservation, reservation.bedId);
                }
            },

            async saveReservation(houseId, roomId, bedIndex, bedName, existingId, bedId) {
                const guestName = document.getElementById('guestName').value;
                const checkIn = document.getElementById('checkIn').value;
                const checkOut = document.getElementById('checkOut').value;

                if (!guestName || !checkIn || !checkOut) {
                    alert('Por favor completa los campos obligatorios (Nombre, Check-in, Check-out)');
                    return;
                }

                const reservation = {
                    id: existingId || crypto.randomUUID(),
                    bedId,
                    guestName,
                    email: document.getElementById('guestEmail').value,
                    phone: document.getElementById('guestPhone').value,
                    checkIn,
                    checkOut,
                    status: document.getElementById('slotStatus').value === 'ocupado' ? 'ocupado' : 'libre',
                    paymentValue: parseFloat(document.getElementById('totalPrice').value) || 0,
                    deposit: parseFloat(document.getElementById('deposit').value) || 0,
                    totalPaid: parseFloat(document.getElementById('totalPaid').value) || 0,
                    packageType: document.getElementById('packageType').value,
                    surfLevel: document.getElementById('surfLevel').value,
                    packageDays: parseInt(document.getElementById('packageDays').value) || 0,
                    notes: document.getElementById('notes').value,
                    houseId,
                    roomId,
                    bedIndex,
                    bedName
                };

                if (existingId) {
                    this.reservations = this.reservations.map(r => r.id === existingId ? reservation : r);
                } else {
                    this.reservations.push(reservation);
                }

                await this.syncReservationToSupabase(reservation);
                this.saveData();
                this.closeModal();
                this.render();
            },

            calculateBalance() {
                const totalPrice = parseFloat(document.getElementById('totalPrice')?.value || 0);
                const totalPaid = parseFloat(document.getElementById('totalPaid')?.value || 0);
                const balance = totalPrice - totalPaid;

                if (document.getElementById('displayTotal')) {
                    document.getElementById('displayTotal').textContent = `R$ ${totalPrice.toFixed(2)}`;
                    document.getElementById('displayPaid').textContent = `R$ ${totalPaid.toFixed(2)}`;
                    document.getElementById('displayBalance').textContent = `R$ ${balance.toFixed(2)}`;
                }
            },

            bookFullHouse(houseId, date) {
                const guestName = prompt('Nombre del hu√©sped (reserva casa completa):');
                if (!guestName) return;

                const house = this.houses.find(h => h.id === houseId);
                const checkOut = prompt('Fecha de Check-out (YYYY-MM-DD):', date);
                if (!checkOut) return;

                // Remove existing reservations for this date range
                this.reservations = this.reservations.filter(r =>
                    !(r.houseId === houseId &&
                        ((r.checkIn <= date && r.checkOut >= date) ||
                            (r.checkIn <= checkOut && r.checkOut >= checkOut)))
                );

                // Book all beds in all rooms
                house.rooms.forEach(room => {
                    room.beds.forEach((bedName, bedIndex) => {
                        this.reservations.push({
                            id: Date.now() + Math.random(),
                            houseId,
                            roomId: room.id,
                            bedIndex,
                            bedName,
                            guestName,
                            checkIn: date,
                            checkOut: checkOut,
                            fullHouse: true,
                            createdAt: new Date().toISOString()
                        });
                    });
                });

                this.saveData();
                this.closeModal();
                this.render();
            },

            async deleteReservation(id) {
                if (confirm('¬øEliminar esta reserva?')) {
                    try {
                        const { error } = await supabaseClient
                            .from('reservations')
                            .delete()
                            .eq('id', id);

                        if (error) throw error;

                        this.reservations = this.reservations.filter(r => r.id !== id);
                        this.saveData();
                        this.closeModal();
                        this.render();
                    } catch (error) {
                        console.error('Error eliminando de Supabase:', error);
                        alert('Error al eliminar en Supabase');
                    }
                }
            },

            showNewReservation() {
                alert('Haz clic en cualquier d√≠a del calendario para crear una reserva');
            },

            closeModal() {
                document.getElementById('reservationModal').classList.remove('active');
            },

            previousMonth() {
                this.currentMonth = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth() - 1);
                this.render();
            },

            nextMonth() {
                this.currentMonth = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth() + 1);
                this.render();
            },

            currentMonthView() {
                this.currentMonth = new Date();
                this.render();
            },

            async saveData() {
                localStorage.setItem('boardxperience_reservations', JSON.stringify(this.reservations));
                // Aqu√≠ podr√≠as llamar a una funci√≥n para sincronizar con Supabase en tiempo real
            },

            async syncReservationToSupabase(res) {
                try {
                    const { error } = await supabaseClient
                        .from('reservations')
                        .upsert({
                            id: res.id,
                            bed_id: res.bedId,
                            guest_name: res.guestName,
                            guest_email: res.email,
                            guest_phone: res.phone,
                            check_in: res.checkIn,
                            check_out: res.checkOut,
                            status: res.status,
                            payment_value: res.paymentValue,
                            deposit: res.deposit,
                            total_paid: res.totalPaid,
                            package_type: res.packageType,
                            surf_level: res.surfLevel,
                            package_days: res.packageDays,
                            notes: res.notes
                        });
                    if (error) throw error;
                } catch (error) {
                    console.error('Error sincronizando con Supabase:', error);
                }
            },

            exportData() {
                const dataStr = JSON.stringify(this.reservations, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `boardxperience-reservas-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            },

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            this.reservations = JSON.parse(event.target.result);
                            this.saveData();
                            this.render();
                            alert('Datos importados correctamente');
                        } catch (error) {
                            alert('Error al importar datos');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            async migrateInitialDataToSupabase() {

                try {
                    for (const houseData of this.houses) {
                        const { data: house, error: hErr } = await supabaseClient
                            .from('houses')
                            .insert({
                                name: houseData.name,
                                icon: houseData.icon,
                                subtitle: houseData.subtitle
                            })
                            .select()
                            .single();

                        if (hErr) throw hErr;

                        for (const roomData of houseData.rooms) {
                            const { data: room, error: rErr } = await supabaseClient
                                .from('rooms')
                                .insert({
                                    house_id: house.id,
                                    name: roomData.name,
                                    type: roomData.type
                                })
                                .select()
                                .single();

                            if (rErr) throw rErr;

                            for (const bedName of roomData.beds) {
                                const { error: bErr } = await supabaseClient
                                    .from('beds')
                                    .insert({
                                        room_id: room.id,
                                        name: bedName
                                    });
                                if (bErr) throw bErr;
                            }
                        }
                    }
                    console.log('Migraci√≥n completada con √©xito.');
                    location.reload();
                } catch (error) {
                    console.error('Error en migraci√≥n:', error);
                    alert('Error durante la migraci√≥n: ' + error.message);
                }
            }
        };

        // Close modal when clicking outside
        document.getElementById('reservationModal').addEventListener('click', (e) => {
            if (e.target.id === 'reservationModal') {
                app.closeModal();
            }
        });

        // Initialize app
        app.init();
    </script>
</body>

</html>